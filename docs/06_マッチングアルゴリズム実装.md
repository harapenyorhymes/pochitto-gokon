# 06. マッチングアルゴリズム実装

## 概要
登録された希望を基に、適切なグループを自動生成するマッチングアルゴリズムを実装する。

## 作業内容

### マッチング条件定義
- [x] 基本マッチング条件の整理
- [x] 性別バランス（男女各2-4名）
- [x] 日程・エリアの一致
- [x] 年齢層の考慮

### マッチングアルゴリズム
- [x] 基本マッチングロジック (lib/matching.ts)
- [x] ソロ参加者同士のマッチング
- [ ] 友達グループ同士のマッチング（次フェーズ）
- [ ] 混合マッチング（ソロ+友達グループ）（次フェーズ）

### マッチング処理
- [ ] 定期実行スケジューラー（日次処理）（次フェーズ）
- [x] マッチング結果の保存
- [x] マッチング失敗時の処理
- [x] 再マッチング機能

### グループ管理
- [x] グループ作成機能
- [x] グループメンバーの管理
- [x] グループ状態の管理
- [x] グループ解散機能

### マッチング結果処理
- [ ] マッチング成功通知（LINE通知、次フェーズ）
- [ ] チャットルーム自動作成（次フェーズ）
- [ ] 参加者への案内メール/LINE送信（次フェーズ）
- [x] マッチング結果の表示

### API設計
- [x] マッチング実行API (api/matching/execute)
- [x] マッチング状態取得API (api/matching/status)
- [x] グループ情報取得API (api/groups/[id])
- [x] マッチング履歴API (api/matching/history)

## 完了条件
- 基本マッチングアルゴリズムが動作する
- 性別バランスが適切に保たれる
- マッチング結果が正しく保存される
- 参加者に適切に通知される
- エラーケースが適切にハンドリングされる

## マッチングアルゴリズム詳細

### Step 1: 候補グループ抽出
- 同じ日程・エリアの希望者を抽出
- 参加方式別にグループ化

### Step 2: 性別バランス調整
- 男女比が1:1に近くなるよう調整
- 最小2名、最大8名でグループ形成

### Step 3: グループ最適化
- 年齢層のバランス
- 友達グループのサイズ考慮
- 過去の参加履歴考慮（将来実装）

### Step 4: マッチング確定
- グループ情報をデータベースに保存
- 参加者への通知準備
- チャットルーム作成

## データ構造

### groups テーブル
- id (UUID)
- event_date (date)
- area_id (FK to areas)
- status ('formed' | 'active' | 'completed' | 'cancelled')
- created_at (timestamp)

### group_members テーブル
- id (UUID)
- group_id (FK to groups)
- user_id (FK to users)
- joined_at (timestamp)

## 注意事項
- マッチング処理の重複実行防止
- 大量データでのパフォーマンス考慮
- マッチング失敗時のユーザー体験