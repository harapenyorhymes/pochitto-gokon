# 07. グループチャット機能

## 概要
マッチング成立後のグループメンバー間でリアルタイムチャットを行う機能を実装する。

## 作業内容

### チャット基盤構築
- [x] Supabase Realtimeの設定
- [x] チャットルーム自動作成機能
- [x] リアルタイムメッセージング
- [x] メッセージ履歴の管理

### チャットUI実装
- [x] チャットルーム画面 (app/chat/[groupId]/page.tsx)
- [x] メッセージ表示コンポーネント (components/MessageList.tsx)
- [x] メッセージ入力コンポーネント (components/MessageInput.tsx)
- [ ] チャットルーム一覧 (app/chat/page.tsx)（次フェーズ）

### メッセージ機能
- [x] テキストメッセージ送信
- [x] メッセージの既読機能（基本実装）
- [x] タイムスタンプ表示
- [ ] メッセージの削除機能（送信者のみ）（次フェーズ）

### チャット管理
- [x] グループメンバーのみアクセス可能
- [x] チャットルームの有効期限設定
- [ ] 不適切な投稿の報告機能（次フェーズ）
- [ ] チャット履歴のエクスポート（次フェーズ）

### リアルタイム機能
- [x] メッセージのリアルタイム表示
- [ ] オンライン状態の表示（次フェーズ）
- [ ] 入力中表示（typing indicator）（次フェーズ）
- [ ] 未読メッセージ数の表示（次フェーズ）

### セキュリティ
- [ ] メッセージの暗号化（将来実装）
- [ ] 不適切な内容のフィルタリング
- [ ] スパム防止機能
- [ ] ブロック機能

## 完了条件
- グループメンバー間でリアルタイムチャットが可能
- メッセージが適切に保存・表示される
- セキュリティが適切に設定されている
- UI/UXが使いやすい
- エラーハンドリングが実装されている

## UI設計要件

### チャットルーム
- シンプルで分かりやすいデザイン
- モバイルフレンドリーなレスポンシブ対応
- メッセージの送信者が分かりやすい表示

### メッセージ表示
- 自分のメッセージは右寄せ
- 他人のメッセージは左寄せ
- ニックネーム付きで表示
- タイムスタンプは見やすい位置に

## データ構造

### group_chats テーブル
- id (UUID)
- group_id (FK to groups)
- created_at (timestamp)
- expires_at (timestamp)

### messages テーブル
- id (UUID)
- chat_id (FK to group_chats)
- user_id (FK to users)
- content (text)
- message_type ('text' | 'system')
- created_at (timestamp)
- updated_at (timestamp)
- deleted_at (timestamp, nullable)

### message_reads テーブル
- id (UUID)
- message_id (FK to messages)
- user_id (FK to users)
- read_at (timestamp)

## API設計

### メッセージAPI
- POST /api/chat/[groupId]/messages - メッセージ送信
- GET /api/chat/[groupId]/messages - メッセージ取得
- DELETE /api/chat/messages/[messageId] - メッセージ削除

### チャット管理API
- GET /api/chat/[groupId] - チャットルーム情報取得
- POST /api/chat/[groupId]/read - 既読更新

## 注意事項
- リアルタイム通信のパフォーマンス考慮
- メッセージの適切な表示順序
- 接続エラー時の再接続処理
- プライバシー保護とセキュリティ