# プロフィール機能仕様書

## 1. 概要

ポチッと合コンアプリのプロフィール機能は、ユーザーが自分の基本情報を登録・管理する機能です。
合コンマッチングの基礎となる重要な機能で、新規会員登録時の統合フォームと既存ユーザーの編集機能を提供します。

## 2. 機能一覧

### 2.1 プロフィール登録（新規会員登録時）
- 新規会員登録と同時にプロフィール情報を入力
- 生年月日から年齢を自動計算
- バリデーション機能付きフォーム

### 2.2 プロフィール表示
- 登録済みプロフィールの表示
- 年齢・性別・自己紹介の表示

### 2.3 プロフィール編集
- 既存プロフィール情報の更新
- ニックネームの重複チェック

## 3. データ項目

### 3.1 必須項目
| 項目名 | データ型 | 制約 | 説明 |
|--------|----------|------|------|
| ニックネーム | 文字列 | 2-20文字、英数字・ひらがな・カタカナ・漢字のみ、重複可能 | 表示名として使用 |
| 生年月日 | 日付 | 18歳以上70歳未満になる日付 | 年齢計算に使用 |
| 性別 | 列挙型 | male/female | マッチング条件 |
| 自己紹介 | テキスト | 10-500文字 | 相手へのアピール文 |

### 3.2 自動生成項目
| 項目名 | データ型 | 説明 |
|--------|----------|------|
| 年齢 | 数値 | 生年月日から自動計算 |
| プロフィール完了フラグ | 真偽値 | 必須項目が全て入力済みかどうか |
| 作成日時 | 日時 | プロフィール初回作成日時 |
| 更新日時 | 日時 | 最終更新日時 |

## 4. 画面遷移・ユーザーフロー

### 4.1 新規会員登録フロー

```
トップページ
    ↓（無料で始めるクリック）
新規会員登録ページ（統合フォーム）
    ↓（アカウント作成クリック）
    ├─ セッションあり → ダッシュボード（プロフィール即座反映）
    └─ セッションなし → 成功画面（メール確認待ち）
                    ↓（メールリンククリック）
                ログイン → ダッシュボード（プロフィール自動保存）
```

### 4.2 プロフィール管理フロー

```
ダッシュボード
    ↓（プロフィール表示）
プロフィール表示ページ
    ↓（編集ボタン）
プロフィール編集ページ
    ↓（保存）
プロフィール表示ページ（更新完了）
```

## 5. 技術仕様

### 5.1 フロントエンド
- **フレームワーク**: Next.js 14 (App Router)
- **バリデーション**: React Hook Form + Zod
- **UI**: Tailwind CSS
- **状態管理**: React Hooks

### 5.2 バックエンド
- **API**: Next.js API Routes
- **データベース**: Supabase (PostgreSQL)
- **認証**: Supabase Auth

### 5.3 データベーステーブル構造

```sql
-- profilesテーブル
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  nickname VARCHAR(20) NOT NULL,
  age INTEGER NOT NULL CHECK (age >= 18 AND age < 70),
  gender VARCHAR(10) NOT NULL CHECK (gender IN ('male', 'female')),
  bio TEXT NOT NULL,
  is_complete BOOLEAN DEFAULT false,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

## 6. バリデーションルール

### 6.1 ニックネーム
- **文字数**: 2文字以上20文字以下
- **使用可能文字**: 英数字、ひらがな、カタカナ、漢字、スペース
- **重複チェック**: なし（重複可能）
- **エラーメッセージ**:
  - `ニックネームは2文字以上で入力してください`
  - `ニックネームは20文字以下で入力してください`
  - `特殊文字は使用できません`

### 6.2 生年月日・年齢
- **年齢範囲**: 18歳以上70歳未満
- **未来日付**: 入力不可
- **自動計算**: 生年月日から現在年齢を計算
- **エラーメッセージ**:
  - `生年月日を入力してください`
  - `18歳以上70歳未満である必要があります`
  - `未来の日付は入力できません`

### 6.3 性別
- **選択肢**: 男性/女性
- **必須**: 選択必須
- **エラーメッセージ**: `性別を選択してください`

### 6.4 自己紹介
- **文字数**: 10文字以上500文字以下
- **文字数表示**: リアルタイム文字数カウンター
- **不適切語句フィルター**: 基本的な不適切語句をチェック
- **エラーメッセージ**:
  - `自己紹介は10文字以上で入力してください`
  - `自己紹介は500文字以下で入力してください`
  - `不適切な内容が含まれています`

## 7. API仕様

### 7.1 プロフィール取得 (GET /api/profile)

**リクエスト**
```
GET /api/profile
Authorization: Bearer Token (Supabase Session)
```

**レスポンス（成功）**
```json
{
  "success": true,
  "data": {
    "id": "user-uuid",
    "nickname": "太郎",
    "age": 25,
    "gender": "male",
    "bio": "よろしくお願いします！",
    "is_complete": true,
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-01T00:00:00Z"
  }
}
```

**レスポンス（プロフィール未作成）**
```json
{
  "success": true,
  "data": null
}
```

### 7.2 プロフィール作成・更新 (POST /api/profile)

**リクエスト**
```json
{
  "nickname": "太郎",
  "age": 25,
  "gender": "male",
  "bio": "はじめまして！よろしくお願いします。"
}
```

**レスポンス（成功）**
```json
{
  "success": true,
  "data": {
    "id": "user-uuid",
    "nickname": "太郎",
    "age": 25,
    "gender": "male",
    "bio": "はじめまして！よろしくお願いします。",
    "is_complete": true,
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-01T00:00:00Z"
  },
  "message": "プロフィールを保存しました"
}
```

**レスポンス（エラー）**
```json
{
  "success": false,
  "error": "入力値が無効です"
}
```

## 8. エラーハンドリング

### 8.1 認証エラー
- **状況**: 未ログイン状態でのAPI呼び出し
- **レスポンス**: 401 Unauthorized
- **画面表示**: ログインページにリダイレクト

### 8.2 バリデーションエラー
- **状況**: 入力値が制約に違反
- **レスポンス**: 400 Bad Request
- **画面表示**: フィールド下部にエラーメッセージ表示

### 8.3 ~~重複エラー~~（削除）
- ~~**状況**: ニックネームが他ユーザーと重複~~
- ~~**レスポンス**: 400 Bad Request~~
- ~~**画面表示**: ニックネーム欄にエラーメッセージ~~
- **※ ニックネームの重複チェックは廃止されました**

### 8.4 サーバーエラー
- **状況**: データベース接続エラーなど
- **レスポンス**: 500 Internal Server Error
- **画面表示**: 一般的なエラーメッセージ

## 9. セキュリティ仕様

### 9.1 認証・認可
- **認証**: Supabase Auth による JWT トークン認証
- **認可**: ユーザーは自分のプロフィールのみ参照・編集可能
- **RLS**: Row Level Security による データアクセス制御

### 9.2 入力検証
- **XSS対策**: 入力値のサニタイズ
- **SQLインジェクション対策**: ParameterizedQuery使用
- **CSRF対策**: Next.js標準のCSRF保護

### 9.3 データ保護
- **暗号化**: HTTPS通信による暗号化
- **データマスキング**: ログでの個人情報マスキング
- **アクセスログ**: API アクセスの監査ログ

## 10. パフォーマンス仕様

### 10.1 レスポンス時間
- **プロフィール取得**: 500ms以内
- **プロフィール保存**: 1000ms以内
- **画面表示**: 2秒以内

### 10.2 キャッシュ戦略
- **ブラウザキャッシュ**: 静的リソースのキャッシュ
- **API キャッシュ**: プロフィール情報の短期キャッシュ

## 11. 保留プロフィール機能

### 11.1 概要
メール確認が必要な場合の新規登録において、プロフィール情報を一時保存し、ログイン時に自動保存する機能

### 11.2 動作フロー
```
新規登録（メール確認必要）
    ↓
プロフィール情報をLocalStorageに保存
    ↓（メール確認後）
ログイン
    ↓
LocalStorageからプロフィール取得 → API保存 → LocalStorage削除
```

### 11.3 技術仕様
- **保存場所**: ブラウザのLocalStorage
- **保存キー**: `pendingProfile`
- **保存期間**: ログイン成功まで（手動削除）
- **データ形式**: JSON文字列

## 12. 今後の拡張予定

### 12.1 プロフィール写真
- 画像アップロード機能
- 画像の最適化・リサイズ
- 不適切画像の自動検出

### 12.2 詳細プロフィール
- 職業情報
- 趣味タグ
- 居住地詳細
- 身長・体型情報

### 12.3 プロフィール公開設定
- 公開範囲の設定
- マッチング前の情報制限
- プライバシー設定

## 13. テスト仕様

### 13.1 単体テスト
- バリデーション関数のテスト
- API エンドポイントのテスト
- 年齢計算ロジックのテスト

### 13.2 結合テスト
- プロフィール登録フローのテスト
- 保留プロフィール機能のテスト
- 認証連携のテスト

### 13.3 E2Eテスト
- 新規登録からプロフィール表示までの完全フロー
- 異なるブラウザでの動作確認
- モバイル端末での動作確認

---

**作成日**: 2024年12月20日
**最終更新**: 2024年12月20日
**作成者**: ポチッと合コン開発チーム