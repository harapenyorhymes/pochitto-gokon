# 日程登録機能仕様書

## 1. 概要

ポチッと合コンアプリの日程登録機能は、ユーザーが合コン参加希望日程を登録・管理する機能です。
複数日程の登録、時間帯選択、参加方式（ソロ・友達同伴）の設定により、効率的なマッチングの基礎を提供します。

## 2. 機能一覧

### 2.1 日程登録
- カレンダーUIによる直感的な日付選択（7日間表示）
- 複数日程の同時登録
- 時間帯選択（18:00-20:00・20:00-22:00・両方選択可能）
- 日付クリック→時間帯選択の2段階UI
- 参加方式選択（ソロ・友達同伴）
- エリア指定（MVPでは名古屋栄エリア固定）

### 2.2 日程管理
- 登録済み日程の一覧表示
- 日程の個別削除（未マッチング分のみ）
- 日程の一括更新
- マッチング状況の確認

### 2.3 マッチング統合
- 他ユーザーとの日程マッチング
- 性別バランス考慮
- グループ形成アルゴリズム

## 3. データ項目

### 3.1 基本項目
| 項目名 | データ型 | 制約 | 説明 |
|--------|----------|------|------|
| 日程 | 日付 | 今日以降の日付 | 合コン希望日 |
| 時間帯 | 列挙型 | evening/night | 18:00-20:00・20:00-22:00 |
| エリア | UUID | 外部キー参照 | 開催エリア（MVPでは栄固定） |
| 参加方式 | 列挙型 | solo/group | ソロ参加・友達同伴 |
| 最大参加者数 | 数値 | 2-6名 | グループ最大人数 |

### 3.2 自動生成項目
| 項目名 | データ型 | 説明 |
|--------|----------|------|
| イベントID | UUID | 一意識別子 |
| ユーザーID | UUID | 登録者識別子 |
| ステータス | 列挙型 | pending/matched/completed/cancelled |
| 作成日時 | 日時 | 登録日時 |
| 更新日時 | 日時 | 最終更新日時 |

## 4. 画面遷移・ユーザーフロー

### 4.1 日程登録フロー

```
ダッシュボード
    ↓（日程を登録するボタン）
日程登録ページ
    ├─ カレンダー選択
    ├─ 時間帯選択
    ├─ 参加方式選択
    └─ 友達選択（グループ参加時）
    ↓（登録完了）
ダッシュボード（登録確認）
```

### 4.2 日程管理フロー

```
ダッシュボード
    ↓（登録済み日程表示）
日程一覧
    ├─ 個別削除
    ├─ 編集
    └─ マッチング状況確認
    ↓
詳細表示・マッチング結果
```

## 5. 技術仕様

### 5.1 フロントエンド
- **フレームワーク**: Next.js 14 (App Router)
- **UI**: Tailwind CSS + カスタムカレンダーコンポーネント
- **状態管理**: React Hooks + SWR（データフェッチ）
- **バリデーション**: React Hook Form + Zod

### 5.2 バックエンド
- **API**: Next.js API Routes
- **データベース**: Supabase (PostgreSQL)
- **認証**: Supabase Auth
- **リアルタイム更新**: Supabase Realtime

### 5.3 データベーステーブル構造

```sql
-- eventsテーブル（合コンイベント希望）
CREATE TABLE events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  event_date DATE NOT NULL,
  event_time TIME NOT NULL,
  area_id UUID NOT NULL REFERENCES areas(id),
  participation_type VARCHAR(20) NOT NULL CHECK (participation_type IN ('solo', 'group')),
  max_participants INTEGER DEFAULT 4,
  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'matched', 'completed', 'cancelled')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- event_participantsテーブル（友達参加用）
CREATE TABLE event_participants (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  event_id UUID NOT NULL REFERENCES events(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  role VARCHAR(20) NOT NULL CHECK (role IN ('organizer', 'participant')),
  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'accepted', 'declined')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(event_id, user_id)
);
```

## 6. バリデーションルール

### 6.1 日程選択
- **選択可能日**: 今日以降の日付のみ
- **最大選択数**: 10日程まで
- **重複チェック**: 同一日時での重複登録不可
- **エラーメッセージ**:
  - `過去の日付は選択できません`
  - `最大10日程まで選択可能です`
  - `同じ日時での重複登録はできません`

### 6.2 時間帯選択
- **選択肢**: 18:00-20:00、20:00-22:00（複数選択可能）
- **UI**: 日付選択後に時間帯ボタンが表示される2段階UI
- **必須**: 最低1つの時間帯選択が必要
- **エラーメッセージ**: `時間帯を選択してください`

### 6.3 参加方式選択
- **選択肢**: ソロ参加/友達同伴
- **制約**: 友達同伴時は友達選択が必要
- **最大人数**: 本人含めて6名まで
- **エラーメッセージ**:
  - `参加方式を選択してください`
  - `友達同伴の場合は友達を選択してください`
  - `最大6名まで参加可能です`

## 7. API仕様

### 7.1 日程取得 (GET /api/events)

**リクエスト**
```
GET /api/events
Authorization: Bearer Token (Supabase Session)
```

**レスポンス（成功）**
```json
{
  "events": [
    {
      "id": "event-uuid",
      "user_id": "user-uuid",
      "event_date": "2024-01-15",
      "event_time": "18:00:00",
      "area_id": "area-uuid",
      "participation_type": "solo",
      "max_participants": 4,
      "status": "pending",
      "created_at": "2024-01-01T00:00:00Z",
      "updated_at": "2024-01-01T00:00:00Z",
      "event_participants": []
    }
  ]
}
```

### 7.2 日程登録・更新 (POST /api/events)

**リクエスト**
```json
{
  "events": [
    {
      "event_date": "2024-01-15",
      "event_time": "18:00:00",
      "area_id": "area-uuid",
      "participation_type": "solo",
      "max_participants": 4
    }
  ]
}
```

**レスポンス（成功）**
```json
{
  "events": [
    {
      "id": "new-event-uuid",
      "user_id": "user-uuid",
      "event_date": "2024-01-15",
      "event_time": "18:00:00",
      "area_id": "area-uuid",
      "participation_type": "solo",
      "max_participants": 4,
      "status": "pending",
      "created_at": "2024-01-01T00:00:00Z",
      "updated_at": "2024-01-01T00:00:00Z"
    }
  ]
}
```

### 7.3 日程削除 (DELETE /api/events)

**リクエスト**
```
DELETE /api/events?id=event-uuid
Authorization: Bearer Token (Supabase Session)
```

**レスポンス（成功）**
```json
{
  "success": true
}
```

## 8. エラーハンドリング

### 8.1 認証エラー
- **状況**: 未ログイン状態でのAPI呼び出し
- **レスポンス**: 401 Unauthorized
- **画面表示**: ログインページにリダイレクト

### 8.2 バリデーションエラー
- **状況**: 不正な日程データ
- **レスポンス**: 400 Bad Request
- **画面表示**: フィールド下部にエラーメッセージ表示

### 8.3 データベースエラー
- **状況**: 日程の重複登録など
- **レスポンス**: 409 Conflict
- **画面表示**: 警告メッセージ表示

### 8.4 サーバーエラー
- **状況**: データベース接続エラーなど
- **レスポンス**: 500 Internal Server Error
- **画面表示**: 一般的なエラーメッセージ

## 9. セキュリティ仕様

### 9.1 認証・認可
- **認証**: Supabase Auth による JWT トークン認証
- **認可**: ユーザーは自分の日程のみ参照・編集可能
- **RLS**: Row Level Security による データアクセス制御

### 9.2 入力検証
- **XSS対策**: 入力値のサニタイズ
- **SQLインジェクション対策**: ParameterizedQuery使用
- **CSRF対策**: Next.js標準のCSRF保護

### 9.3 データ保護
- **暗号化**: HTTPS通信による暗号化
- **データマスキング**: ログでの個人情報マスキング
- **アクセスログ**: API アクセスの監査ログ

## 10. パフォーマンス仕様

### 10.1 レスポンス時間
- **日程取得**: 500ms以内
- **日程登録**: 1000ms以内
- **画面表示**: 2秒以内

### 10.2 キャッシュ戦略
- **ブラウザキャッシュ**: 静的リソースのキャッシュ
- **SWRキャッシュ**: 日程データの短期キャッシュ
- **データベースキャッシュ**: 頻繁にアクセスされるエリアデータ

## 11. UI/UX仕様

### 11.1 カレンダーコンポーネント
- **表示形式**: 月次カレンダービュー
- **操作方法**: クリック/タップによる日付選択
- **視覚的フィードバック**: 選択日のハイライト表示
- **レスポンシブ**: モバイル・デスクトップ対応

### 11.2 時間帯選択UI
- **表示形式**: 日付選択後に表示されるボタン形式
- **操作方法**: 複数時間帯の同時選択可能
- **選択肢**:
  - 🌙 夕方（18:00-20:00）
  - 🌃 夜（20:00-22:00）
- **視覚的表示**:
  - 未選択: グレー背景
  - 選択済み: 青・紫のカラー背景
  - ホバー時: カラー背景
- **選択状態表示**: 18:00-22:00（両方選択時）の統合表示

### 11.3 参加方式選択UI
- **表示形式**: トグルスイッチまたはタブ形式
- **選択肢**:
  - 👤 ソロ参加（一人で参加）
  - 👥 友達同伴（友達と一緒に参加）

## 12. マッチングアルゴリズム仕様

### 12.1 基本条件
- **日程一致**: 同一日時での参加希望者
- **エリア一致**: 同一エリア内での開催
- **性別バランス**: 男女各2-4名でのグループ形成

### 12.2 優先順位
1. **完全マッチ**: 日程・時間・エリアが完全一致
2. **時間フレキシブル**: 終日選択者との柔軟マッチング
3. **人数バランス**: 理想的な男女比（2:2, 3:3, 4:4）

### 12.3 マッチング実行
- **実行タイミング**: 毎日深夜2時にバッチ処理
- **通知**: マッチング成立時にLINE通知
- **グループ形成**: 自動でチャットルーム作成

## 13. 今後の拡張予定

### 13.1 高度な日程管理
- **定期日程**: 毎週・毎月の定期参加設定
- **キャンセル機能**: マッチング後のキャンセル対応
- **リマインダー**: 合コン前日・当日の通知

### 13.2 詳細な時間設定
- **カスタム時間**: ユーザー指定の時間帯
- **複数時間帯**: 一日に複数の時間帯選択
- **時間幅設定**: 柔軟な開始・終了時間

### 13.3 エリア拡張
- **複数エリア**: 東京・大阪・福岡への展開
- **エリア横断**: 複数エリアでの参加可能設定
- **詳細ロケーション**: 駅・施設レベルでの場所指定

### 13.4 ソーシャル機能
- **友達招待**: アプリ内での友達招待システム
- **グループ作成**: 事前の友達グループ形成
- **評価システム**: 参加者同士の評価機能

## 14. テスト仕様

### 14.1 単体テスト
- バリデーション関数のテスト
- API エンドポイントのテスト
- マッチングアルゴリズムのテスト

### 14.2 結合テスト
- 日程登録フローのテスト
- マッチング処理の統合テスト
- 通知システムとの連携テスト

### 14.3 E2Eテスト
- 日程登録からマッチングまでの完全フロー
- 異なるブラウザでの動作確認
- モバイル端末での操作テスト

## 15. 現在の実装状況

### 15.1 完了済み機能
- ✅ 基本API（GET/POST/DELETE /api/events）
- ✅ イベントデータの作成・取得・削除
- ✅ 基本的なバリデーション
- ✅ 認証・認可システム

### 15.2 実装済み機能
- ✅ カレンダーUIコンポーネント（SimpleDateTimeSelector）
- ✅ 時間帯選択UI（2段階選択、複数選択対応）
- ✅ 参加方式選択UI（ParticipationTypeSelector）
- ✅ 日程登録ページ（/events）
- ✅ 選択内容のサマリー表示

### 15.3 実装が必要な機能
- 🔄 日程管理画面（登録済み日程の確認・削除）
- 🔄 マッチングアルゴリズム
- 🔄 リアルタイム更新機能

### 15.4 改善が必要な機能
- 🔧 コンポーネントの重複排除とリファクタリング
- 🔧 パフォーマンス最適化（useMemo、useCallback活用）
- 🔧 TypeScript型定義の強化
- 🔧 カスタムフック化による状態管理の改善
- 🔧 定数の外部化と型安全性向上

## 16. 技術的改善提案

### 16.1 パフォーマンス最適化
- `useMemo`による計算結果のメモ化
- `useCallback`によるイベントハンドラーの最適化
- 重複コンポーネントの統合（TimeSlotButton）

### 16.2 コード品質向上
- カスタムフック化（useEventRegistration）
- 定数の外部化（constants/timeSlots.ts, constants/areas.ts）
- 型安全性の強化（TimeSlotId, EventCreateRequest/Response）

### 16.3 メンテナビリティ向上
- コンポーネントの責務分離
- 共通ロジックのユーティリティ化
- エラーハンドリングの統一化

---

**作成日**: 2024年12月20日
**最終更新**: 2024年12月20日
**作成者**: ポチッと合コン開発チーム