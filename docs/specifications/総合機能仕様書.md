# ポチッと合コン 総合機能仕様書

## 1. システム概要

### 1.1 サービス概要
「ポチッと合コン」は、マッチングアプリ疲れした20代〜30代前半を対象とした、AIによる自動合コンセッティングサービスです。
ユーザーは空いている日程を登録するだけで、AIが最適な相手とお店を選択し、面倒な調整なしで合コンに参加できます。

### 1.2 ターゲットユーザー
- **年齢層**: 18〜35歳
- **居住地**: 名古屋栄エリア（MVP版）
- **特徴**: マッチングアプリに疲れ、手軽な出会いを求める人

### 1.3 サービスの価値提案
- **簡単**: 日程登録だけで参加可能
- **自動**: AIによる相手・店舗選択
- **安心**: 事前チャットでの交流
- **無料**: MVP版は完全無料

## 2. システム構成

### 2.1 技術スタック

#### フロントエンド
- **フレームワーク**: Next.js 14.2 (App Router)
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS
- **UI コンポーネント**: Headless UI
- **フォーム管理**: React Hook Form + Zod
- **状態管理**: React Context + Hooks

#### バックエンド
- **BaaS**: Supabase
- **データベース**: PostgreSQL
- **認証**: Supabase Auth
- **リアルタイム**: Supabase Realtime
- **API**: Next.js API Routes

#### 外部サービス
- **LINE連携**: LINE Login API + Messaging API
- **ホスティング**: Vercel
- **監視**: Vercel Analytics

### 2.2 アーキテクチャ図

```
[ユーザー]
    ↓ HTTPS
[Vercel (Next.js)]
    ↓ API
[Supabase (PostgreSQL + Auth + Realtime)]
    ↓ Webhook
[LINE Messaging API]
```

## 3. 機能一覧

### 3.1 認証機能
- **新規会員登録**: プロフィール統合フォーム
- **ログイン/ログアウト**: メール認証
- **パスワード管理**: 変更・リセット機能
- **セッション管理**: 自動ログイン・期限管理
- **保留プロフィール**: メール確認待ち時の一時保存

### 3.2 プロフィール機能
- **プロフィール登録**: ニックネーム・年齢・性別・自己紹介
- **年齢自動計算**: 生年月日から年齢算出
- **プロフィール表示**: 登録情報の確認
- **プロフィール編集**: 情報更新機能
- **バリデーション**: 入力値検証・重複チェック

### 3.3 日程・参加登録機能
- **カレンダー選択**: 複数日程の選択可能
- **時間帯選択**: 平日夜・土日夜の選択
- **参加方式選択**: ソロ参加・友達参加
- **エリア選択**: 名古屋栄エリア固定（MVP）
- **希望登録**: データベースへの保存

### 3.4 マッチング機能
- **自動マッチング**: 日程・エリア・性別バランス考慮
- **マッチング条件**: 最小4名〜最大8名のグループ
- **年齢考慮**: 年齢差10歳以内での組み合わせ
- **マッチング実行**: 手動実行（将来的に自動化）
- **マッチング通知**: LINE通知でお知らせ

### 3.5 グループ・チャット機能
- **グループ管理**: マッチング成立グループの一覧
- **リアルタイムチャット**: Supabase Realtime使用
- **メッセージ送信**: テキストメッセージ対応
- **参加者表示**: グループメンバーの表示
- **チャット履歴**: メッセージ履歴の保存

### 3.6 通知機能
- **LINE連携**: LINE Messaging API
- **通知設定**: 種別ごとの ON/OFF 設定
- **通知テンプレート**: マッチング・チャット・リマインド
- **一括通知**: 複数ユーザーへの同時通知
- **通知履歴**: 送信履歴の記録

### 3.7 ダッシュボード機能
- **概要表示**: ユーザーステータス概要
- **マッチング状況**: 現在のマッチング情報
- **統計表示**: 参加履歴・成功率
- **クイックアクション**: 主要機能への導線

## 4. データベース設計

### 4.1 主要テーブル

#### users（ユーザー）
```sql
-- Supabase Auth管理
id UUID PRIMARY KEY,
email VARCHAR(255) UNIQUE NOT NULL,
email_confirmed_at TIMESTAMP,
last_sign_in_at TIMESTAMP
```

#### profiles（プロフィール）
```sql
id UUID PRIMARY KEY REFERENCES auth.users(id),
nickname VARCHAR(20) NOT NULL UNIQUE,
age INTEGER NOT NULL CHECK (age >= 18 AND age <= 35),
gender VARCHAR(10) NOT NULL CHECK (gender IN ('male', 'female')),
bio TEXT NOT NULL,
is_complete BOOLEAN DEFAULT false,
created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
```

#### events（イベント希望）
```sql
id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
event_date DATE NOT NULL,
event_time TIME NOT NULL,
area_id UUID NOT NULL REFERENCES areas(id),
participation_type VARCHAR(20) NOT NULL CHECK (participation_type IN ('solo', 'group')),
status VARCHAR(20) DEFAULT 'pending',
created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
```

#### groups（マッチンググループ）
```sql
id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
event_date DATE NOT NULL,
event_time TIME NOT NULL,
area_id UUID NOT NULL REFERENCES areas(id),
status VARCHAR(20) DEFAULT 'formed',
created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
```

#### group_members（グループメンバー）
```sql
id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
group_id UUID NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
role VARCHAR(20) DEFAULT 'member',
created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
```

#### chat_rooms（チャットルーム）
```sql
id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
group_id UUID NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
expires_at TIMESTAMP WITH TIME ZONE
```

#### messages（メッセージ）
```sql
id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
chat_id UUID NOT NULL REFERENCES chat_rooms(id) ON DELETE CASCADE,
user_id UUID REFERENCES users(id) ON DELETE SET NULL,
content TEXT NOT NULL,
message_type VARCHAR(20) DEFAULT 'text',
created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
```

#### notification_settings（通知設定）
```sql
id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
match_notifications BOOLEAN DEFAULT true,
chat_notifications BOOLEAN DEFAULT true,
reminder_notifications BOOLEAN DEFAULT true,
line_connected BOOLEAN DEFAULT false,
line_user_id VARCHAR(255),
created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
```

### 4.2 Row Level Security (RLS)

```sql
-- プロフィールは本人のみアクセス可能
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view own profile" ON profiles
FOR SELECT USING (auth.uid() = id);

-- イベントは本人のみ作成・参照可能
ALTER TABLE events ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can manage own events" ON events
FOR ALL USING (auth.uid() = user_id);

-- グループメンバーは参加者のみ参照可能
ALTER TABLE group_members ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Members can view own groups" ON group_members
FOR SELECT USING (auth.uid() = user_id);

-- メッセージはグループメンバーのみアクセス可能
ALTER TABLE messages ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Group members can access messages" ON messages
FOR ALL USING (
  EXISTS (
    SELECT 1 FROM group_members gm
    JOIN chat_rooms cr ON cr.group_id = gm.group_id
    WHERE cr.id = messages.chat_id AND gm.user_id = auth.uid()
  )
);
```

## 5. API設計

### 5.1 認証API

```typescript
// 新規登録（プロフィール統合）
POST /api/auth/signup
{
  email: string,
  password: string,
  profile: {
    nickname: string,
    age: number,
    gender: 'male' | 'female',
    bio: string
  }
}

// ログイン
POST /api/auth/signin
{
  email: string,
  password: string
}

// ログアウト
POST /api/auth/signout
```

### 5.2 プロフィールAPI

```typescript
// プロフィール取得
GET /api/profile

// プロフィール作成・更新
POST /api/profile
{
  nickname: string,
  age: number,
  gender: 'male' | 'female',
  bio: string
}
```

### 5.3 イベント・マッチングAPI

```typescript
// イベント希望登録
POST /api/events
{
  events: Array<{
    event_date: string,
    event_time: string,
    area_id: number,
    participation_type: 'solo' | 'group',
    status: 'pending'
  }>
}

// マッチング実行
POST /api/matching/execute

// マッチング状況取得
GET /api/matching/status
```

### 5.4 グループ・チャットAPI

```typescript
// グループ一覧取得
GET /api/groups

// グループ詳細取得
GET /api/groups/[id]

// チャットルーム取得
GET /api/chat/[groupId]

// メッセージ送信
POST /api/chat/[groupId]/messages
{
  content: string,
  message_type: 'text' | 'system'
}

// メッセージ一覧取得
GET /api/chat/[groupId]/messages
```

### 5.5 通知API

```typescript
// 通知設定取得
GET /api/notifications/settings

// 通知設定更新
PUT /api/notifications/settings
{
  match_notifications: boolean,
  chat_notifications: boolean,
  reminder_notifications: boolean,
  line_connected: boolean
}

// LINE連携
POST /api/line/connect
GET /api/line/callback
```

## 6. ユーザーフロー

### 6.1 新規登録〜初回参加フロー

```
1. トップページ訪問
   ↓
2. 「無料で始める」クリック
   ↓
3. 新規登録フォーム入力
   - メール・パスワード
   - ニックネーム・生年月日・性別・自己紹介
   ↓
4. アカウント作成
   ├─ 即座ログイン → 6へ
   └─ メール確認必要 → 5へ
   ↓
5. メール確認 → ログイン
   ↓
6. ダッシュボード表示
   ↓
7. 「参加希望を登録」
   ↓
8. 日程・時間・参加方式選択
   ↓
9. 希望登録完了
   ↓
10. マッチング実行（運営側）
    ↓
11. マッチング成立通知（LINE）
    ↓
12. チャットルーム作成
    ↓
13. 事前交流
    ↓
14. 当日合コン実施
```

### 6.2 継続利用フロー

```
1. ログイン
   ↓
2. ダッシュボード確認
   ├─ マッチング中 → チャット参加
   ├─ 新規希望登録 → 日程選択
   └─ プロフィール更新 → 編集画面
```

## 7. セキュリティ仕様

### 7.1 認証・認可
- **JWT認証**: Supabase Authによるトークンベース認証
- **Row Level Security**: データベースレベルでのアクセス制御
- **セッション管理**: 自動期限切れ・リフレッシュ
- **CSRF対策**: Next.js標準保護

### 7.2 データ保護
- **HTTPS通信**: 全通信の暗号化
- **パスワード暗号化**: bcrypt + salt
- **個人情報保護**: 最小限のデータ収集
- **ログマスキング**: 機密情報の非表示

### 7.3 入力検証
- **フロントエンド**: React Hook Form + Zod
- **バックエンド**: API レベルでの再検証
- **SQLインジェクション対策**: Parameterized Query
- **XSS対策**: 入力値サニタイズ

## 8. パフォーマンス要件

### 8.1 レスポンス時間
- **ページ表示**: 2秒以内
- **API レスポンス**: 1秒以内
- **リアルタイム更新**: 500ms以内

### 8.2 スケーラビリティ
- **同時接続数**: 100ユーザー（MVP）
- **データベース**: PostgreSQL（Supabase）
- **CDN**: Vercel Edge Network
- **キャッシュ戦略**: ブラウザ・API キャッシュ

## 9. 監視・運用

### 9.1 ログ・監視
- **アプリケーションログ**: Next.js server logs
- **データベースログ**: Supabase monitoring
- **エラー追跡**: Vercel Analytics
- **パフォーマンス監視**: Core Web Vitals

### 9.2 バックアップ・復旧
- **データベース**: Supabase自動バックアップ
- **ソースコード**: GitHub版本管理
- **設定ファイル**: 環境変数管理
- **復旧手順**: 運用マニュアル

## 10. デプロイ・環境

### 10.1 環境構成

#### 開発環境
- **ローカル**: Next.js dev server (localhost:3000)
- **データベース**: Supabase開発プロジェクト
- **認証**: Supabase Auth（メール確認無効）

#### 本番環境
- **ホスティング**: Vercel Production
- **データベース**: Supabase本番プロジェクト
- **ドメイン**: カスタムドメイン設定
- **SSL**: Let's Encrypt自動更新

### 10.2 CI/CD

```yaml
# GitHub Actions
name: Deploy
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to Vercel
        uses: vercel/action@v1
```

## 11. 今後の拡張計画

### 11.1 フェーズ2（3ヶ月後）
- **エリア拡大**: 東京・大阪・福岡
- **店舗連携**: ホットペッパーグルメAPI
- **写真機能**: プロフィール写真アップロード
- **レビュー機能**: 合コン後の評価システム

### 11.2 フェーズ3（6ヶ月後）
- **AIマッチング**: OpenAI APIによる高度なマッチング
- **プレミアムプラン**: 有料機能の追加
- **イベント機能**: 季節限定・テーマ別合コン
- **紹介機能**: 友達招待システム

### 11.3 フェーズ4（1年後）
- **モバイルアプリ**: React Native対応
- **企業向け**: 法人利用プラン
- **国際展開**: 多言語対応
- **パートナーシップ**: 飲食店・イベント会社との提携

## 12. 運用・サポート

### 12.1 カスタマーサポート
- **問い合わせ**: メールサポート
- **FAQ**: よくある質問集
- **利用規約**: 規約・プライバシーポリシー
- **通報機能**: 不適切行為の報告

### 12.2 コミュニティ管理
- **コンテンツモデレーション**: 不適切投稿の検出
- **ユーザー管理**: アカウント停止・警告
- **イベント監視**: 合コン実施状況の確認
- **フィードバック収集**: ユーザー満足度調査

---

**作成日**: 2024年12月20日
**最終更新**: 2024年12月20日
**作成者**: ポチッと合コン開発チーム
**バージョン**: 1.0.0 (MVP)