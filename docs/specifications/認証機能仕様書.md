# 認証機能仕様書

## 1. 概要

ポチッと合コンアプリの認証機能は、ユーザーのアカウント管理とセキュアなアプリケーションアクセスを提供します。
メール認証ベースの安全な認証システムを採用し、将来的なLINE連携認証にも対応できる設計となっています。

## 2. 認証方式

### 2.1 メール認証
- **主要認証方式**: メールアドレス + パスワード
- **メール確認**: 新規登録時のメールアドレス確認
- **パスワードリセット**: メール経由でのパスワード再設定

### 2.2 将来対応予定
- **LINE連携**: LINE Loginを使用したソーシャル認証
- **二要素認証**: SMS/TOTPによる追加セキュリティ

## 3. 機能一覧

### 3.1 新規会員登録
- 統合プロフィール入力フォーム
- メールアドレス確認機能
- パスワード強度チェック
- 利用規約同意

### 3.2 ログイン
- メールアドレス + パスワード認証
- 自動ログイン機能（Remember Me）
- 保留プロフィール自動保存

### 3.3 ログアウト
- セッション無効化
- ローカルデータ削除

### 3.4 パスワード管理
- パスワード変更
- パスワードリセット
- 強度チェック機能

## 4. データ項目

### 4.1 ユーザーアカウント情報
| 項目名 | データ型 | 制約 | 説明 |
|--------|----------|------|------|
| メールアドレス | 文字列 | 有効なメール形式、一意 | ログインID |
| パスワード | 文字列 | 8文字以上、英数字記号のみ | 認証情報 |
| メール確認状況 | 真偽値 | - | アカウント有効化状況 |
| 最終ログイン | 日時 | - | セキュリティ管理用 |

### 4.2 セッション情報
| 項目名 | データ型 | 説明 |
|--------|----------|------|
| アクセストークン | JWT | API認証トークン |
| リフレッシュトークン | JWT | トークン更新用 |
| セッション有効期限 | 日時 | 自動ログアウト時刻 |

## 5. 画面遷移・ユーザーフロー

### 5.1 新規会員登録フロー

```
トップページ
    ↓（無料で始める）
新規会員登録ページ
    ↓（フォーム入力・送信）
    ├─ 即座にセッション確立 → ダッシュボード
    └─ メール確認必要 → 確認メール送信画面
                    ↓（メールリンククリック）
                アカウント有効化 → ログインページ
                    ↓（ログイン）
                ダッシュボード（保留プロフィール自動保存）
```

### 5.2 ログインフロー

```
ログインページ
    ↓（メール・パスワード入力）
    ├─ 認証成功 → ダッシュボード
    ├─ 認証失敗 → エラー表示（ログインページ）
    └─ メール未確認 → メール確認案内
```

### 5.3 パスワードリセットフロー

```
ログインページ
    ↓（パスワードを忘れた場合）
パスワードリセット申請ページ
    ↓（メールアドレス入力・送信）
リセットメール送信完了画面
    ↓（メールリンククリック）
新しいパスワード設定ページ
    ↓（新パスワード入力・保存）
ログインページ（パスワード更新完了）
```

## 6. 技術仕様

### 6.1 認証プロバイダー
- **Supabase Auth**: 主要認証基盤
- **JWT**: アクセストークン形式
- **セッション管理**: Supabase Session Management

### 6.2 セキュリティ機能
- **パスワードハッシュ化**: bcrypt アルゴリズム
- **CSRF保護**: Next.js標準保護
- **XSS対策**: 入力値サニタイズ
- **セッション管理**: 自動期限切れ・更新

### 6.3 フロントエンド
- **認証Context**: React Context API
- **認証ガード**: ページアクセス制御
- **状態管理**: React Hooks
- **永続化**: ブラウザのSecure Storage

## 7. パスワードポリシー

### 7.1 強度要件
- **最小文字数**: 8文字以上
- **使用可能文字**: 英数字と記号（日本語不可）
- **禁止パターン**: 辞書語、連続文字、個人情報

### 7.2 バリデーションルール
```typescript
const passwordRegex = /^[a-zA-Z0-9!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*$/
const minLength = 8
```

### 7.3 エラーメッセージ
- `パスワードは8文字以上で入力してください`
- `パスワードは英数字と記号のみ使用できます`
- `現在のパスワードが間違っています`

## 8. API仕様

### 8.1 新規会員登録 (POST /auth/signup)

**リクエスト**
```typescript
interface SignUpRequest {
  email: string
  password: string
  // プロフィール情報も同時送信
  profile: {
    nickname: string
    age: number
    gender: 'male' | 'female'
    bio: string
  }
}
```

**レスポンス（成功）**
```json
{
  "user": {
    "id": "user-uuid",
    "email": "user@example.com",
    "email_confirmed_at": null
  },
  "session": null // メール確認が必要な場合
}
```

### 8.2 ログイン (POST /auth/signin)

**リクエスト**
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

**レスポンス（成功）**
```json
{
  "user": {
    "id": "user-uuid",
    "email": "user@example.com",
    "email_confirmed_at": "2024-01-01T00:00:00Z"
  },
  "session": {
    "access_token": "jwt-token",
    "refresh_token": "refresh-token",
    "expires_at": 1234567890
  }
}
```

### 8.3 ログアウト (POST /auth/signout)

**リクエスト**
```
POST /auth/signout
Authorization: Bearer {access_token}
```

**レスポンス**
```json
{
  "message": "ログアウトしました"
}
```

## 9. 認証状態管理

### 9.1 AuthContext

```typescript
interface AuthContextType {
  user: User | null
  loading: boolean
  signUp: (email: string, password: string) => Promise<AuthResult>
  signIn: (email: string, password: string) => Promise<AuthResult>
  signOut: () => Promise<void>
}
```

### 9.2 認証ガード

```typescript
interface AuthGuardProps {
  requireAuth?: boolean // 認証必須かどうか
  redirectTo?: string  // リダイレクト先
  children: React.ReactNode
}
```

### 9.3 保護ページ

認証が必要なページ:
- `/dashboard` - ダッシュボード
- `/profile` - プロフィール管理
- `/preferences` - 日程登録
- `/groups` - グループ管理
- `/chat/*` - チャット
- `/settings/*` - 設定

認証不要なページ:
- `/` - トップページ
- `/login` - ログイン
- `/signup` - 新規登録
- `/auth/*` - 認証関連

## 10. Middleware仕様

### 10.1 認証チェック
```typescript
export async function middleware(request: NextRequest) {
  const { user } = await supabase.auth.getUser()

  // 保護ページへの未認証アクセスをチェック
  if (!user && isProtectedRoute(request.nextUrl.pathname)) {
    return NextResponse.redirect(new URL('/login', request.url))
  }

  return NextResponse.next()
}
```

### 10.2 除外パス
- `/login`, `/signup`, `/auth/*`
- `/_next/*` (Next.js内部ファイル)
- `/api/auth/*` (認証API)
- `/` (トップページ)

## 11. エラーハンドリング

### 11.1 認証エラー種別

| エラーコード | 説明 | 対応方法 |
|-------------|------|----------|
| `invalid_credentials` | メール・パスワード不正 | エラーメッセージ表示 |
| `email_not_confirmed` | メール未確認 | 確認メール再送案内 |
| `too_many_requests` | ログイン試行回数超過 | 一時的なアクセス制限 |
| `weak_password` | パスワード強度不足 | 強度要件の説明 |
| `email_already_exists` | メールアドレス重複 | 既存アカウントの案内 |

### 11.2 エラーメッセージ

```typescript
const errorMessages = {
  'invalid_credentials': 'メールアドレスまたはパスワードが正しくありません',
  'email_not_confirmed': 'メールアドレスの確認が完了していません',
  'email_already_exists': 'このメールアドレスは既に登録されています',
  'weak_password': 'パスワードは8文字以上で入力してください',
  'too_many_requests': 'しばらく時間をおいてから再度お試しください'
}
```

## 12. セキュリティ対策

### 12.1 認証セキュリティ
- **パスワード暗号化**: bcrypt + salt
- **セッション管理**: HTTPOnly Cookie
- **トークン更新**: 自動リフレッシュ
- **ブルートフォース対策**: レート制限

### 12.2 通信セキュリティ
- **HTTPS強制**: 全通信の暗号化
- **CORS設定**: 適切なオリジン制限
- **CSP設定**: XSS攻撃対策

### 12.3 データ保護
- **個人情報暗号化**: データベース内暗号化
- **ログマスキング**: 機密情報のマスク
- **監査ログ**: アクセス履歴の記録

## 13. パフォーマンス要件

### 13.1 認証処理時間
- **ログイン**: 1秒以内
- **新規登録**: 2秒以内
- **トークン更新**: 500ms以内

### 13.2 セッション管理
- **セッション期限**: 24時間
- **自動更新**: アクティブ時に延長
- **リフレッシュ間隔**: 15分

## 14. 保留プロフィール機能

### 14.1 概要
新規登録時にメール確認が必要な場合、プロフィール情報を一時保存し、ログイン後に自動保存する機能

### 14.2 実装詳細
```typescript
// 新規登録時（セッションなし）
localStorage.setItem('pendingProfile', JSON.stringify(profileData))

// ログイン時（AuthContext）
const pendingProfile = localStorage.getItem('pendingProfile')
if (pendingProfile && user) {
  await saveProfile(JSON.parse(pendingProfile))
  localStorage.removeItem('pendingProfile')
}
```

### 14.3 データ形式
```typescript
interface PendingProfile {
  nickname: string
  age: number
  gender: 'male' | 'female'
  bio: string
}
```

## 15. 監視・ログ

### 15.1 認証ログ
- ログイン成功/失敗
- 新規登録
- パスワード変更
- セッション期限切れ

### 15.2 セキュリティ監視
- 異常なログイン試行
- 複数IPからのアクセス
- API レート制限抵触

## 16. 今後の拡張

### 16.1 ソーシャル認証
- **LINE Login**: LINE連携認証
- **Google OAuth**: Google アカウント連携
- **Apple Sign-In**: Apple ID 連携

### 16.2 セキュリティ強化
- **二要素認証**: SMS/TOTP
- **デバイス管理**: 信頼できるデバイス
- **異常検知**: 不正アクセス検知

### 16.3 ユーザビリティ向上
- **パスワードレス認証**: マジックリンク
- **生体認証**: Face ID / Touch ID
- **シングルサインオン**: 企業向け認証

---

**作成日**: 2024年12月20日
**最終更新**: 2024年12月20日
**作成者**: ポチッと合コン開発チーム